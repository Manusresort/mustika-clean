name: Verify repository invariants

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Block runtime state tracking (allow runtime code)
        run: |
          set -e
          # runtime is a tracked surface; state inside runtime/* is generated and must not be committed
          if git ls-files | grep -E '^(indices/|runtime/(indices|runs|audit|proposals|closures)/|runtime/\.venv|runtime/\.venv_)' >/dev/null; then
            echo "ERROR: tracked runtime state or indices detected (forbidden by repo invariants)." >&2
            echo "Tracked paths (matches):" >&2
            git ls-files | grep -E '^(indices/|runtime/(indices|runs|audit|proposals|closures)/|runtime/\.venv|runtime/\.venv_)' >&2
            exit 1
          fi
          echo "OK: runtime code tracked; no runtime state or indices tracked."

      - name: Ensure governance docs exist
        run: |
          set -e
          for path in \
            docs/GITHUB_USAGE_BOUNDARY.md \
            docs/REPO_FREEZE.md \
            docs/REPO_MIGRATION_VERIFICATION.md \
            documentation/system_overview/AS_BUILT_ARCH.md \
            documentation/system_overview/GOVERNANCE.md
          do
            if [ ! -f "$path" ]; then
              echo "ERROR: missing required doc: $path" >&2
              exit 1
            fi
          done
          echo "OK: required governance docs present."

      - name: Validate meta snapshot JSON
        run: |
          set -e
          test -f meta/SNAPSHOT.json
          python -m json.tool meta/SNAPSHOT.json >/dev/null
          echo "OK: meta/SNAPSHOT.json parses."
