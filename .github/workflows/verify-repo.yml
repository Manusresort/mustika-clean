name: Verify repository invariants

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Block runtime state tracking (allow runtime code)
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking tracked files for forbidden runtime state paths..."
          # runtime is tracked; state inside runtime/* is generated and must not be committed
          forbidden='^(indices/|runtime/(runs|indices|proposals|closures|audit|\.venv))'
          allow='^runtime/audit/.+/MIGRATION_CLOSEOUT_NOTE\.md$'
          offenders="$(git ls-files | rg "${forbidden}" | rg -v "${allow}" || true)"
          if [ -n "${offenders}" ]; then
            echo "ERROR: forbidden tracked runtime/state paths detected:"
            echo "${offenders}"
            exit 1
          fi
          echo "OK: no forbidden runtime/state paths tracked."


      - name: Ensure governance docs exist
        run: |
          set -e
          for path in \
            docs/GITHUB_USAGE_BOUNDARY.md \
            docs/REPO_FREEZE.md \
            docs/REPO_MIGRATION_VERIFICATION.md \
            documentation/system_overview/AS_BUILT_ARCH.md \
            documentation/system_overview/GOVERNANCE.md
          do
            if [ ! -f "$path" ]; then
              echo "ERROR: missing required doc: $path" >&2
              exit 1
            fi
          done
          echo "OK: required governance docs present."

      - name: Validate meta snapshot JSON
        run: |
          set -e
          test -f meta/SNAPSHOT.json
          python -m json.tool meta/SNAPSHOT.json >/dev/null
          echo "OK: meta/SNAPSHOT.json parses."
