# Quick Start Guide â€” Mustika Rasa Human UI

## Prerequisites

- Python 3.8+ (check: `python3 --version`)
- Node.js 18+ and npm (check: `node --version` and `npm --version`)
- macOS

## Project Location

All files are in:
```
/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy/
```

## Local Dev (Mac)

For the complete local workflow, see:
- `docs/SYSTEM_OVERVIEW.md`
- `docs/DEV_WORKFLOW.md`
- `docs/GOVERNANCE.md`

TL;DR:
```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"
./scripts/dev_up.sh
```

## Setup Steps

### 1. Install Backend Dependencies

```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"
pip3 install -r requirements-ui.txt
```

### 2. Install Frontend Dependencies

```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy/ui"
npm install
```

### 3. Start Backend API Server

In terminal 1:
```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"
python3 api_server.py
```

The API will be available at: http://127.0.0.1:8010

### 4. Start Frontend Development Server

In terminal 2:
```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy/ui"
npm run dev
```

The UI will be available at: http://localhost:5173

### 5. Generate Initial Indices

After starting both servers, open the UI and click "Reindex" in the Dashboard, or run:

```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"
python3 indexer.py
```

## Directory Structure

The following directories are created automatically (may be empty initially):
- `runs/` - Run bundles (immutable)
- `proposals/` - Proposal records
- `closures/` - Closure records (immutable)
- `promotion/` - Promotion records (Phase 2)
- `canonical/` - Canonical content (read-only)
- `indices/` - JSON indices (generated by indexer)
- `audit/` - Audit logs

## First Use

1. Start both servers (backend and frontend)
2. Open http://localhost:5173 in your browser
3. Click "Reindex" to generate initial indices
4. If you have existing runs/proposals/closures, they will appear in the Inbox

## Verified End-to-End Test

The following test steps verify the complete workflow from proposal creation to closure. Execute these commands in order:

### Step 1: Create Proposal P-001

```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"

# Create proposal directory
mkdir -p proposals/P-001

# Create proposal.md
cat > proposals/P-001/proposal.md << 'EOF'
# Test Proposal P-001

This is a test proposal for end-to-end verification.
EOF

# Create status.json
cat > proposals/P-001/status.json << 'EOF'
{
  "status": "open",
  "severity": "info"
}
EOF
```

**Expected output**: No errors, files created.

**Verify**:
```bash
ls -la proposals/P-001/
# Should show: proposal.md and status.json
```

### Step 2: Add Required Closure Trigger

```bash
# Create required_closure.json to trigger inbox closure item
cat > proposals/P-001/required_closure.json << 'EOF'
{
  "required": true,
  "types": ["APPROVE", "REJECT"]
}
EOF
```

**Expected output**: No errors, file created.

**Verify**:
```bash
ls -la proposals/P-001/required_closure.json
# Should show the file exists
```

### Step 3: Run Indexer and Verify Inbox

```bash
# Run indexer
python3 indexer.py
```

**Expected output**:
```
Scanning runs...
Scanning proposals...
Scanning closures...
Building inbox index...

Indexing complete:
  Runs: 0
  Proposals: 1
  Closures: 0
  Inbox items: 1

Indices written to: /Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy/indices
```

**Verify closure_needed count**:
```bash
# Check inbox_index.json
python3 -c "import json; data = json.load(open('indices/inbox_index.json')); print('closure_needed:', data['counts']['closure_needed'])"
```

**Expected output**:
```
closure_needed: 1
```

**Alternative verification**:
```bash
cat indices/inbox_index.json | python3 -m json.tool | grep -A 5 "closure_needed"
```

**Expected output**:
```json
    "closure_needed": 1,
```

### Step 4: Create Closure via UI

1. Open http://localhost:5173 in your browser
2. Navigate to Inbox
3. You should see an item with type "closure" and title "Closure needed: Test Proposal P-001"
4. Click on the item or navigate to `/closure/new?proposalId=P-001`
5. Fill in the closure form:
   - **Decision Type**: Select "APPROVE"
   - **Rationale**: Enter at least 10 characters (e.g., "This proposal is approved for testing purposes")
   - **Evidence Paths**: Leave empty or add paths (optional)
   - **Sign-off**: Check the checkbox
6. Click "Create Closure"

**Expected result**: Success message "Closure created successfully!" and redirect to inbox.

### Step 5: Verify Closure Immutability

Attempt to create the same closure again via API:

```bash
# Try to create closure again (should fail)
curl -X POST http://127.0.0.1:8010/closures \
  -H "Content-Type: application/json" \
  -d '{
    "proposal_id": "P-001",
    "decision_type": "APPROVE",
    "rationale": "Second attempt should be blocked",
    "sign_off": true
  }'
```

**Expected output**:
```json
{
  "detail": "Closure CL-20260109-P-001 already exists and is immutable"
}
```

**Expected HTTP status**: `400 Bad Request`

### Step 6: Verify Closure File and Audit Log

**Verify closure directory exists**:
```bash
ls -la closures/CL-20260109-P-001/
```

**Expected output**:
```
total 8
drwxr-xr-x  3 user  staff   96 Jan  9 12:00 .
drwxr-xr-x  3 user  staff   96 Jan  9 12:00 ..
-rw-r--r--  1 user  staff  XXX Jan  9 12:00 closure.json
```

**Verify closure.json content**:
```bash
cat closures/CL-20260109-P-001/closure.json | python3 -m json.tool
```

**Expected output** (example):
```json
{
  "closure_id": "CL-20260109-P-001",
  "created_at": "2026-01-09T12:00:00.000000",
  "created_by": "username",
  "proposal_id": "P-001",
  "source_run_id": null,
  "decision_type": "APPROVE",
  "rationale": "This proposal is approved for testing purposes",
  "evidence_paths": [],
  "sign_off": true
}
```

**Verify proposal status updated**:
```bash
cat proposals/P-001/status.json | python3 -m json.tool
```

**Expected output**:
```json
{
  "status": "closed",
  "severity": "info",
  "closed_at": "2026-01-09T12:00:00.000000",
  "closure_id": "CL-20260109-P-001"
}
```

**Verify audit log exists and contains entry**:
```bash
# Check audit log exists
ls -la audit/api_actions.log
```

**Expected output**: File exists with non-zero size.

```bash
# View audit log entries
cat audit/api_actions.log | python3 -m json.tool
```

**Expected output** (example):
```json
{
  "timestamp": "2026-01-09T12:00:00.000000",
  "message": "Closure created: CL-20260109-P-001",
  "metadata": {
    "closure_id": "CL-20260109-P-001",
    "proposal_id": "P-001",
    "decision_type": "APPROVE"
  }
}
```

### Step 7: Verify Inbox Updated

```bash
# Re-run indexer to update indices
python3 indexer.py
```

**Verify closure_needed is now 0**:
```bash
python3 -c "import json; data = json.load(open('indices/inbox_index.json')); print('closure_needed:', data['counts']['closure_needed'])"
```

**Expected output**:
```
closure_needed: 0
```

**Verify proposal status in inbox**:
```bash
cat indices/inbox_index.json | python3 -m json.tool | grep -A 10 "P-001" || echo "P-001 not in inbox (expected - closed proposals don't appear)"
```

**Expected output**: P-001 should not appear in inbox items (closed proposals are filtered out).

## Troubleshooting

- **Backend won't start**: Check if port 8000 is already in use
- **Frontend won't start**: Check if port 5173 is already in use
- **Empty inbox**: Run the indexer manually or click "Reindex" in the UI
- **API errors**: Check backend terminal for error messages

See `RUNBOOK_TROUBLESHOOTING.md` for detailed troubleshooting.

## Running an Excerpt End-to-End (Runner V2)

### Prerequisites

- Ollama running with `mistral` model: `ollama serve` (in separate terminal)
- Environment variable: `export OPENAI_API_KEY="dummy_local_key"`

### Step 1: Run Excerpt

```bash
cd "/Users/vwvd/Millway/AI-folder/Crew-AI/cursor/codex cli project repo copy"

python3 scripts/mustika_run_excerpt.py \
    --excerpt-id sayur_052_066 \
    --excerpt-source data/origineel/hoofdstuk1.txt \
    --excerpt-version v1 \
    --english data/origineel/hoofdstuk1.txt \
    --rough-nl data/hoofdstuk1_rough_nl_dummy.txt
```

**Expected output**:
```
Run completed successfully: /path/to/runs/sayur_052_066/RUN_SAYUR_052_066_20260109T120000
```

### Step 2: Verify Run Directory

```bash
# Check run directory structure
ls -la runs/sayur_052_066/RUN_*/

# Verify required files exist
ls runs/sayur_052_066/RUN_*/outputs/
# Should show: annotator_primary.json, challenger_primary.json, crew_provisional.json, final.txt, review_notes.md

# Check validator report
cat runs/sayur_052_066/RUN_*/eval/output_contract_checks.txt
# Should show: overall_status: PASS or FAIL
```

### Step 3: Reindex to Update UI

```bash
# Run indexer to update indices
python3 indexer.py
```

**Expected output**:
```
Scanning runs...
Scanning proposals...
Scanning closures...
Building inbox index...

Indexing complete:
  Runs: 1
  Proposals: 1
  Closures: 1
  Inbox items: 1
```

### Step 4: View in UI

1. Open http://localhost:5173
2. Navigate to "Runs" or check Dashboard
3. Click on the run to view details
4. Run should appear in inbox if validator failed (gated status)

### Step 5: Verify Run in Index

```bash
# Check run appears in index
python3 -c "import json; data = json.load(open('indices/run_index.json')); print('Runs:', len(data['runs'])); print('First run:', data['runs'][0]['run_id'] if data['runs'] else 'None')"
```

**Expected output**:
```
Runs: 1
First run: RUN_SAYUR_052_066_20260109T120000
```

## Code References

Main source files:

- **`indexer.py`**: Filesystem scanner
  - `build_inbox_index()`: Builds inbox items from runs/proposals/closures
  - `reindex()`: Generates all JSON indices (inbox_index, run_index, proposal_index, closure_index)
  - Uses `RunLayoutAdapter` to scan both Runner V2 and Phase-8/9 layouts

- **`api_server.py`**: FastAPI backend
  - `GET /inbox`, `GET /runs/{id}`, `GET /proposals/{id}`, `POST /closures`, `POST /reindex`: API endpoints
  - `create_closure()`: Closure creation with immutability check
  - `check_canonical_write()`: Policy check for canonical directory (Phase 2)

- **`src/runner_v2/runner.py`**: Runner V2 core logic
  - `validate_preflight()`: Pre-flight validation (stops on missing metadata)
  - `run()`: Main workflow execution
  - `create_output_files()`: Generate required JSON outputs
  - `run_validator()`: Call validator script

- **`src/runner_v2/run_layout_adapter.py`**: Layout normalization
  - `scan_runner_v2_layout()`: Scan `runs/<excerpt_id>/<run_id>/` structure
  - `scan_phase8_layout()`: Scan `sandbox/phase8_runs/` structure
  - `scan_all()`: Scan all layouts and normalize

- **`scripts/mustika_run_excerpt.py`**: CLI entrypoint for Runner V2

- **`ui/src/api.ts`**: API client
  - `API_BASE = '/api'`: Base URL configuration
  - `api.getInbox()`, `api.createClosure()`, etc.: API method wrappers

- **`ui/src/App.tsx`**: Main router with routes for Dashboard, Inbox, Review, Closure, Run Detail
- **`ui/src/components/Dashboard.tsx`**: Dashboard with inbox counters
- **`ui/src/components/Inbox.tsx`**: Filterable inbox table
- **`ui/src/components/ClosureComposer.tsx`**: Closure creation form
