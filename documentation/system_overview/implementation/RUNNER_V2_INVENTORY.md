# Runner V2 Inventory — Existing Filesystem and Tools

## Filesystem Spine

### Root-Level Directories
- `runs/` - **Empty, intended for new Runner v2 runs** (aligned with UI expectations)
- `proposals/` - Proposal records (non-canonical)
- `closures/` - Closure records (immutable)
- `indices/` - JSON indices (generated by indexer)
- `audit/` - Append-only audit logs
- `canonical/` - Read-only canonical content

### Sandbox Directories (Legacy/Pilot)
- `sandbox/phase8_runs/` - Phase-8 run bundles with structure:
  ```
  P8_RUN_<timestamp>/
    ├── command.txt
    ├── env.txt
    ├── eval/
    │   └── output_contract_checks.txt
    ├── inputs/
    │   ├── english.txt
    │   └── rough_nl.txt
    ├── logs/
    │   └── run.log
    └── outputs/
        └── final.txt
  ```

- `sandbox/phase9_runs/` - Phase-9 run bundles (similar structure)
- `sandbox/crew/run_logs/` - Legacy log location (per-excerpt subdirectories)
- `sandbox/crew/run_outputs/` - Legacy output location (per-excerpt subdirectories)

## Existing Run Pipelines and Tools

### Pipeline Scripts
- `test_multi_agent_fidelity.py` - **Main 3-phase pipeline** (Translation → Readability → Fidelity)
  - Function: `run_pipeline(english_text, rough_dutch_text) -> str`
  - Output format: text + `\n\nOpmerkingen:\n...`
  
- `mustikarasa_codex_cli.py` - CLI wrapper for pipeline
  - Command: `recipe --english <file> --rough-nl <file> --output <file>`

### Pilot Runner (Phase-6)
- `sandbox/crew/run_excerpt_workflow.py` - **Pilot excerpt-aware runner**
  - Location: `sandbox/crew/`
  - Features: Excerpt metadata, log header, config-based execution
  - Output location: `sandbox/crew/run_outputs/{excerpt_id}/{run_id}/`
  - **Status**: Pilot, to be replaced by Runner v2

### Validator and Gate Tools
- `sandbox/tools/phase8_output_contract_validator.sh` - **Output contract validator**
  - Input: `run_dir`
  - Output: `run_dir/eval/output_contract_checks.txt`
  - Checks: Main text non-empty, no governance terms, remarks separator, no meta in main text
  - Exit code: 0 = PASS, 1 = FAIL

- `sandbox/tools/phase8_run_with_gate.sh` - **Wrapper that runs pipeline + validator**
  - Input: `run_dir`, `english_txt`, `rough_nl_txt`
  - Calls: `mustikarasa_codex_cli.py recipe`
  - Then: `phase8_output_contract_validator.sh`
  - Exit code: 0 = PASS, 1 = FAIL

## Existing Index Formats

### Index Files (in `indices/`)
- `run_index.json` - Format:
  ```json
  {
    "generated_at": "ISO timestamp",
    "runs": [
      {
        "run_id": "...",
        "status": "completed|failed|gated",
        "created_at": "ISO timestamp",
        "validator_status": "PASS|FAIL|UNKNOWN",
        "blocking_gates": false,
        "gate_count": 0,
        "signal_count": 0,
        "has_incident": false,
        "manifest": {...}
      }
    ]
  }
  ```

- `proposal_index.json` - Proposal metadata list
- `closure_index.json` - Closure metadata list
- `inbox_index.json` - Inbox items (derived from runs/proposals/closures)

### Current Indexer Behavior
- `indexer.py` scans `runs/` directory (line 34-115)
- Expects structure: `runs/{run_id}/`
- Reads: `manifest.json`, `validator/report.json`, `validator/gates.json`, `signals.json`, `incident.json`
- **Assumption**: Indexer currently expects UI-aligned structure, not sandbox structure

## Assumptions and Decisions

### Runner V2 Output Location
**Decision**: Use `runs/<excerpt_id>/<run_id>/` structure
- Aligns with UI expectations (UI reads from `runs/`)
- Supports excerpt grouping (runs per excerpt in subdirectory)
- Compatible with existing indexer (after adapter update)

### Integration Points
1. **Pipeline**: Call `test_multi_agent_fidelity.run_pipeline()` or `mustikarasa_codex_cli.py recipe`
2. **Validator**: Call `sandbox/tools/phase8_output_contract_validator.sh` after outputs created
3. **Indexer**: Update to scan both `runs/<excerpt_id>/<run_id>/` and `sandbox/phase8_runs/`, `sandbox/phase9_runs/`

### Required Output Files (Runner v2)
Based on Phase-6 spec and existing patterns:
- `command.txt` - CLI command used (for reproducibility)
- `env_allowlist.txt` - Redacted environment variables (security)
- `logs/run.log` - Run log with header
- `outputs/annotator_primary.json` - Main structured output (Phase-6 spec)
- `outputs/challenger_primary.json` - Challenger output (Phase-6 spec)
- `outputs/crew_provisional.json` - Consolidated provisional output (Phase-6 spec)
- `outputs/final.txt` - Final text output (for validator compatibility)
- `eval/output_contract_checks.txt` - Validator report (from validator script)
- `review_notes.md` - Optional human review notes template

### Metadata Embedding
- All JSON outputs must include: `excerpt_id`, `excerpt_source`, `excerpt_version`, `run_id`
- Log header must include: mode, excerpt metadata, run_id, timestamp, status

### Model Configuration
- Use existing `mustikarasa_agents.py` with `make_llm()` (Ollama/Mistral)
- Support config file for model selection (future: OpenAI, other backends)
- Keep model-agnostic design

## Constraints (Must Obey)

- ✅ Do not write to `canonical/` (runner/indexer/UI/backend)
- ✅ Closures remain immutable (no changes to closure system)
- ✅ No auto-promotion (no new governance mechanisms)
- ✅ Preserve existing validator behavior (use existing scripts)
- ✅ Align with UI expectations (runs/ structure)

## Next Steps

1. Implement Runner v2 in `src/runner_v2/` (new module)
2. Create CLI entrypoint `scripts/mustika_run_excerpt.py`
3. Update indexer with `RunLayoutAdapter` for dual layout support
4. Add minimal tests
5. Document in `docs/implementation/RUNNER_V2.md`
