# SYSTEM_OVERVIEW — Mustika Rasa (Local MVP)

## A. What is Mustika Rasa

Mustika Rasa is a local-first editorial system for managing proposals, reviews, and closures around historical cooking texts. It is built to keep human authority explicit while preserving traceability across runs, proposals, and closures.

---

## B. Kernprincipes (MUST / MUST NOT)

MUST:
- human-in-the-loop decisions remain explicit and traceable
- governance follows **signal → gate → closure**
- filesystem is the source of truth; indices are derived

MUST NOT:
- write to `canonical/`
- mutate existing closures (closures are immutable)
- auto-promote anything to canonical

---

## C. Repository kaart (directories)

- `runs/` — immutable run bundles (runner output). Append-only; no edits.
- `proposals/` — non-canonical proposal records. May evolve until closed.
- `closures/` — immutable closure records. Once written, never modified.
- `promotion/` — promotion records (Phase 2, documentary only now).
- `indices/` — derived JSON indices generated by `indexer.py`.
- `audit/` — append-only audit logs (API actions).
- `ui/` — Vite frontend (read-only UI, no direct filesystem writes).
- `src/` — Runner v2 implementation and layout adapters.
- `scripts/` — CLI entrypoints and dev scripts.
- `sandbox/` — validator tooling and experimental runs (non-canonical).

---

## D. End-to-end flow (concreet)

1) **Runner v2** draait een excerpt → schrijft een run bundle in `runs/<excerpt_id>/<RUN_...>/`.
2) **Outputs** worden geschreven → validator draait (`sandbox/tools/phase8_output_contract_validator.sh`) → `eval/output_contract_checks.txt`.
3) **Indexer** scant filesystem → schrijft `indices/*.json`.
4) **API** serveert indices en details (`/inbox`, `/runs/{run_id}`, `/proposals/{proposal_id}`, `/closures/{closure_id}`).
5) **UI** leest via `/api` en toont dashboard, inbox, en run detail.

---

## E. Run Bundle contract (exact pad-layout)

Run directory:
- `runs/<excerpt_id>/<RUN_...>/`

Verplichte paden (Runner v2):
- `outputs/annotator_primary.json`
- `outputs/challenger_primary.json`
- `outputs/crew_provisional.json`
- `eval/output_contract_checks.txt`
- `logs/run.log`

Aanvullend (normaal aanwezig):
- `outputs/final.txt`
- `outputs/review_notes.md`
- `inputs/english.txt`
- `inputs/rough_nl.txt`
- `command.txt`, `env.txt`, `manifest.json`

De API/UI zijn tolerant als `final.txt` ontbreekt (oude of afwijkende runs).

---

## F. Inbox semantics (zoals in indexer.py)

Regels (deterministisch):
- Validator FAIL → `kind: incident`, `severity: high`, `reasons: ["validator_fail"]`
- Blocking gates → `kind: gate`, `severity: high`, `reasons: ["blocking_gate"]`
- Challenger issues (>0) → `kind: review_required`, `severity: medium`, `reasons: ["challenger_issues"]`
- Proposal status open → `kind: review_required`, `severity: low`, `reasons: ["proposal_open"]`
- `required_closure.json` → `kind: closure_needed`, `severity: medium`, `reasons: ["required_closure"]`

Item schema:
- `id`, `kind`, `severity`, `source_type`, `source_id`, `reasons`, `path`

No-duplicates rule:
- dezelfde combinatie `(source_type + source_id + kind)` verschijnt slechts eenmaal.

---

## G. API surface (routes)

- `GET /health` → status + paths
- `GET /inbox` → normalized inbox response
- `GET /runs/{run_id}` → `final_text`, `review_notes`, `validator_report`, `outputs`, `warnings`
- `GET /proposals/{proposal_id}` → proposal details + status
- `GET /closures/{closure_id}` → closure details
- `POST /reindex` → `{ok, exit_code, stdout, stderr, generated_files}`

Errors return JSON via exception handlers.

---

## H. UI pages (verwachtingen)

- **Dashboard**: summary counts + recent activity (via `/inbox`)
- **Inbox**: list items + links to run/proposal
- **Run Detail**: review pack fields + warnings
- UI draait via Vite en proxy’t `/api` naar `http://127.0.0.1:8000`

UI leest uitsluitend via API; geen direct filesystem access.

---

## I. Stability notes / known pitfalls

- Vite port kan `5174` worden als `5173` bezet is.
- Poort `8000` moet `api_server:app` zijn (anders `/health` faalt).
- `.venv` en dependencies moeten aanwezig zijn.
- `indexer.py` is source-of-truth voor indices; UI is read-only.

---

## J. Operations / Dev workflow

TL;DR:
- `./scripts/dev_up.sh`
- open `http://localhost:5173` (of `5174`)

Start/Stop:
- Start: `./scripts/dev_up.sh`
- Stop: `./scripts/dev_down.sh`

Health + inbox:
- `curl http://127.0.0.1:8000/health`
- `curl http://127.0.0.1:8000/inbox`

Logs:
- `audit/api_server.log`
- `audit/ui_dev.log`
- `runs/<excerpt_id>/<RUN_...>/logs/run.log`
