# Execution Layer (Layer 2) — Facts Only

Scope: runtime scripts, run bundles, validator outputs, indices, and execution docs.
No runtime changes. No new design.

---

## Overview (facts)

- Runner V2 executes excerpt-based runs using explicit excerpt metadata.
- Run outputs are written to `runtime/runs/<excerpt_id>/<run_id>/` with standardized files.
- Validator report (output contract) is written to `eval/output_contract_checks.txt` when validator is available.
- Indexer scans filesystem to produce `runtime/indices/*.json` for UI/API consumption.

---

## Runner entrypoints & parameters

| entrypoint | type | parameters | required fields | defaults | output location | evidence |
|---|---|---|---|---|---|---|
| `runtime/scripts/mustika_run_excerpt.py` | CLI | `--excerpt-id`, `--excerpt-source`, `--excerpt-version`, `--english`, `--rough-nl`, `--run-id` | excerpt_id, excerpt_source, excerpt_version, english, rough_nl | run_id auto-generated if missing | `runtime/runs/<excerpt_id>/<run_id>/` | script + `RunnerV2` |
| `runtime/indexer.py` | CLI | none (filesystem scan) | n/a | n/a | writes `runtime/indices/*.json` | indexer.py |
| `runtime/scripts/reindex.sh` | shell | no args (runs indexer) | n/a | uses venv python if present | writes `runtime/indices/*.json` | reindex.sh |

Notes:
- Runner V2 preflight validates excerpt metadata and run_id characters.

---

## Run filesystem contract

Base layout: `runtime/runs/<excerpt_id>/<run_id>/`

| file | role | mandatory | defined in | notes |
|---|---|---|---|---|
| `command.txt` | reproducibility command line | yes | RunnerV2 | written on run start |
| `env_allowlist.txt` | redacted env snapshot | yes | RunnerV2 | safe vars only |
| `manifest.json` | run metadata for indexer | yes | RunnerV2 | contains excerpt metadata + inputs + output_files |
| `logs/run.log` | run log + header | yes | RunnerV2 | header includes excerpt metadata |
| `inputs/english.txt` | captured input | yes | RunnerV2 | saved from CLI inputs |
| `inputs/rough_nl.txt` | captured input | yes | RunnerV2 | saved from CLI inputs |
| `outputs/annotator_primary.json` | structured output | yes | RunnerV2 | includes excerpt metadata |
| `outputs/challenger_primary.json` | structured output | yes | RunnerV2 | placeholder issues[] |
| `outputs/crew_provisional.json` | consolidated output | yes | RunnerV2 | embeds annotator/challenger |
| `outputs/final.txt` | output contract target | yes | RunnerV2 | used by validator |
| `outputs/review_notes.md` | review template | yes | RunnerV2 | generated template |
| `eval/output_contract_checks.txt` | validator report | optional | validator | created if validator script exists |

---

## Excerpt binding (unit of execution)

Excerpt binding is explicit and stored in multiple locations.

| field | stored in | semantics (docs) | validation/guard | evidence |
|---|---|---|---|---|
| excerpt_id | manifest.json, outputs/*.json, logs/run.log, run_index.json | stable excerpt identifier | RunnerV2 preflight requires | RunnerV2 + P6 spec |
| excerpt_source | manifest.json, outputs/*.json, logs/run.log, run_index.json | source path for excerpt | RunnerV2 preflight requires | RunnerV2 + P6 spec |
| excerpt_version | manifest.json, outputs/*.json, logs/run.log, run_index.json | version tag | RunnerV2 preflight requires | RunnerV2 + P6 spec |
| run_id | manifest.json, outputs/*.json, logs/run.log, run_index.json | unique run identifier | RunnerV2 validates characters | RunnerV2 |

Notes:
- P6 excerpt binding spec is documentary; enforcement is implemented only in RunnerV2 preflight.

---

## Indices & queryability

Indices under `runtime/indices/` are generated by `runtime/indexer.py`.

| index | schema (top keys) | primary questions answerable | answerable? | evidence |
|---|---|---|---|---|
| run_index.json | generated_at, runs[] | what runs exist? per excerpt? validator status? | YES | runtime/indices/run_index.json + indexer |
| proposal_index.json | generated_at, proposals[] | which proposals exist? status? | YES | runtime/indices/proposal_index.json + indexer |
| closure_index.json | generated_at, closures[] | which closures exist? linked proposal/run? | YES | runtime/indices/closure_index.json + indexer |
| inbox_index.json | generated_at, items[] | what needs review/gates? | YES | runtime/indices/inbox_index.json + indexer |

Limitations (facts):
- Indices do not expose chapter IDs, RB/BLK, or canonical line ranges.

---

## Evaluation outputs (per-run)

| eval artifact | location | format | schema known? | evidence |
|---|---|---|---|---|
| output_contract_checks.txt | `runtime/runs/<excerpt_id>/<run_id>/eval/` | text report | partial (overall_status PASS/FAIL) | run_layout_adapter + sample runs |

Notes:
- No cross-run comparison artifacts were found in runtime paths.

---

## Invariants (documented vs enforced)

Documented (docs):
- filesystem-first
- immutable runs
- immutable closures
- no auto-promotion
- canonical read-only

Enforced in code (observed):
- RunnerV2 preflight requires excerpt metadata and valid run_id
- Run status set to GATED when validator fails (if validator present)

Not enforced in code (observed):
- immutable closures (no enforcement found in runner/indexer)
- canonical read-only (no enforcement found in runner/indexer)
- no auto-promotion (no enforcement found in runner/indexer)

---

## Current limitations / gaps (facts-only)

- Validator path mismatch: RunnerV2 references `runtime/sandbox/tools/phase8_output_contract_validator.sh`, but validator exists at `sandbox/tools/phase8_output_contract_validator.sh`.
- Pipeline boundary violation: RunnerV2 imports `test_multi_agent_fidelity` (test-named module); file exists in runtime but should not be imported by runtime core.
- No batch runner/orchestrator for chapter-level runs.
- No run intent metadata beyond excerpt metadata, command.txt, and log header.

---

## Layer 2 → Layer 1 linkage status

| Layer 1 object | Linked from runs? | evidence | status |
|---|---|---|---|
| chapter_id | excerpt_source points to `data/origineel/hoofdstuk1.txt` | run manifest + command.txt | PARTIAL (path only; no chapter registry link) |
| segment_id (RB/BLK/SAJUR) | none | run manifests + indices | NOT LINKED |
| page ranges | none | run manifests + indices | NOT LINKED |
| canonical_concat line ranges | none | run manifests + indices | NOT LINKED |
